\chapter{Usage Guide}
\hypertarget{md_guides_2usage}{}\label{md_guides_2usage}\index{Usage Guide@{Usage Guide}}
\label{md_guides_2usage_autotoc_md11}%
\Hypertarget{md_guides_2usage_autotoc_md11}%
\hypertarget{md_guides_2usage_autotoc_md12}{}\doxysection{\texorpdfstring{Overview}{Overview}}\label{md_guides_2usage_autotoc_md12}
Ecto-\/\+Trigger comprises a basic \href{https://ross-jg.github.io/ecto-trigger/html/annotated.html}{\texttt{ collection of files}}. Where each file defines a class and command-\/line interface for independent tasks.

This guide explains how to use each of the scripts in the Ecto-\/\+Trigger toolkit -\/ from training a model to running inference.

All the tools are modular, so you can use them together, or independently depending on your needs. Each script is also well documented with comments to make it easy to extend.\hypertarget{md_guides_2usage_autotoc_md13}{}\doxysection{\texorpdfstring{Suggested Workflow}{Suggested Workflow}}\label{md_guides_2usage_autotoc_md13}

\begin{DoxyEnumerate}
\item Prepare your dataset in class-\/based folders
\item Train a model ({\ttfamily model\+\_\+trainer.\+py})
\item Evaluate it ({\ttfamily model\+\_\+evaluator.\+py})
\item Quantise for deployment ({\ttfamily model\+\_\+quantiser.\+py})
\item Deploy to field hardware (\doxysectlink{md_guides_2deployment}{Deployment Guide}{0})
\item Optionally visualize attention maps ({\ttfamily saliency\+\_\+map\+\_\+evaluator.\+py})
\end{DoxyEnumerate}\hypertarget{md_guides_2usage_autotoc_md14}{}\doxysection{\texorpdfstring{\href{../model_loader.py}{\texttt{ model\+\_\+loader.\+py}}}{\href{../model_loader.py}{\texttt{ model\+\_\+loader.\+py}}}}\label{md_guides_2usage_autotoc_md14}
This file contains a class, {\ttfamily Model\+Loader}, with static methods {\ttfamily create\+\_\+model()}, {\ttfamily load\+\_\+keras\+\_\+model()} and {\ttfamily load\+\_\+tflite\+\_\+model()}.

These are intended to be accessed from other files, as loading a model on its own is not much use. Below is shown how to load a model using {\ttfamily python}.


\begin{DoxyCode}{0}
\DoxyCodeLine{\textcolor{keyword}{from}\ model\_loader\ \textcolor{keyword}{import}\ ModelLoader}
\DoxyCodeLine{}
\DoxyCodeLine{\textcolor{comment}{\#\ this\ line\ will\ load\ a\ Keras\ model\ from\ a\ .hdf5\ checkpoint\ file}}
\DoxyCodeLine{k\_model\ =\ ModelLoader.load\_keras\_model(\textcolor{stringliteral}{"{}path/to/weights.hdf5"{}})}
\DoxyCodeLine{}
\DoxyCodeLine{\textcolor{comment}{\#\ this\ line\ will\ load\ a\ compressed\ tflite\ model\ from\ a\ .tflite\ file}}
\DoxyCodeLine{q\_model\ =\ ModelLoader.load\_tflite\_model(\textcolor{stringliteral}{"{}path/to/weights.tflite"{}})}
\DoxyCodeLine{}
\DoxyCodeLine{\textcolor{comment}{\#\ to\ create\ your\ own\ model,\ use\ the\ function\ below}}
\DoxyCodeLine{k\_model\ =\ ModelLoader.create\_model((1080,\ 1080,\ 3),\ 0.5,\ dropout\_rate=0.2,\ freeze\_base=\textcolor{keyword}{False})}

\end{DoxyCode}



\begin{DoxyCode}{0}
\DoxyCodeLine{>\ Input:\ \ .hdf5\ file\ (Keras\ model)}
\DoxyCodeLine{>\ Output:\ TensorFlow\ model\ object}

\end{DoxyCode}
\hypertarget{md_guides_2usage_autotoc_md15}{}\doxysection{\texorpdfstring{\href{../model_trainer.py}{\texttt{ model\+\_\+trainer.\+py}}}{\href{../model_trainer.py}{\texttt{ model\+\_\+trainer.\+py}}}}\label{md_guides_2usage_autotoc_md15}
This file contains a class, {\ttfamily Model\+Trainer}, which can be instantiated in Python as shown\+:


\begin{DoxyCode}{0}
\DoxyCodeLine{\textcolor{keyword}{from}\ model\_trainer\ \textcolor{keyword}{import}\ ModelTrainer}
\DoxyCodeLine{}
\DoxyCodeLine{mt\ =\ ModelTrainer(\{\textcolor{stringliteral}{"{}train\_data\_dir"{}}:\ \textcolor{stringliteral}{"{}/path/to/train/data"{}},\ \textcolor{stringliteral}{"{}val\_data\_dir"{}}:\ \textcolor{stringliteral}{"{}/path/to/val/data"{}},\ \textcolor{stringliteral}{"{}batch\_size"{}}\ :\ 16,\ \textcolor{stringliteral}{"{}input\_shape"{}}\ :\ (120,160,3),\ \textcolor{stringliteral}{"{}alpha"{}}:\ 0.35,\ \textcolor{stringliteral}{"{}log\_dir"{}}\ :\ \textcolor{stringliteral}{"{}logs"{}},\ \textcolor{stringliteral}{"{}model\_type"{}}:\ \textcolor{stringliteral}{"{}Mobnetv2"{}},\ \textcolor{stringliteral}{"{}epochs"{}}\ :\ 2,\ \textcolor{stringliteral}{"{}use\_pretrained\_weights"{}}\ :\ \textcolor{keyword}{False}\})\ }
\DoxyCodeLine{mt.train()}

\end{DoxyCode}


You can also call {\ttfamily model\+\_\+trainer.\+py} from the command line\+: 
\begin{DoxyCode}{0}
\DoxyCodeLine{python\ model\_trainer.py\ \(\backslash\)}
\DoxyCodeLine{\ \ \ \ -\/-\/train\_data\_dir\ "{}/path/to/train/data"{}\ \(\backslash\)}
\DoxyCodeLine{\ \ \ \ -\/-\/val\_data\_dir\ "{}/path/to/validation/data"{}\ \(\backslash\)}
\DoxyCodeLine{\ \ \ \ -\/-\/batch\_size\ 16\ \(\backslash\)}
\DoxyCodeLine{\ \ \ \ -\/-\/input\_shape\ "{}(120,\ 160,\ 3)"{}\ \(\backslash\)}
\DoxyCodeLine{\ \ \ \ -\/-\/alpha\ 0.35\ \(\backslash\)}
\DoxyCodeLine{\ \ \ \ -\/-\/log\_dir\ "{}logs"{}\ \(\backslash\)}
\DoxyCodeLine{\ \ \ \ -\/-\/epochs\ 20\ \(\backslash\)}

\end{DoxyCode}



\begin{DoxyCode}{0}
\DoxyCodeLine{>\ Input:\ Folder(s)\ of\ labelled\ images\ in\ YOLO\ format\ for\ training\ and\ validation}
\DoxyCodeLine{>\ Output:\ Trained\ \`{}.hdf5`\ model,\ logs\ for\ TensorBoard}

\end{DoxyCode}


Organise your dataset in YOLO-\/format for training, follow this structure\+:


\begin{DoxyCode}{0}
\DoxyCodeLine{your\_data\_train/}
\DoxyCodeLine{|-\/-\/\ img001.jpg}
\DoxyCodeLine{|-\/-\/\ \ img001.txt}
\DoxyCodeLine{|-\/-\/\ \ img002.jpg}
\DoxyCodeLine{|-\/-\/\ \ img002.txt}
\DoxyCodeLine{|-\/-\/\ \ ...}
\DoxyCodeLine{your\_data\_val/}
\DoxyCodeLine{|-\/-\/\ \ img001.jpg}
\DoxyCodeLine{|-\/-\/\ \ img001.txt}
\DoxyCodeLine{|-\/-\/\ \ img002.jpg}
\DoxyCodeLine{|-\/-\/\ \ img002.txt}
\DoxyCodeLine{|-\/-\/\ \ ...}

\end{DoxyCode}
 Each .txt file should contain the YOLO-\/style annotation for its corresponding image (for more information about the YOLO format, see \href{https://roboflow.com/formats/yolo-darknet-txt}{\texttt{ here}})\+:

For images with the object of interest\+: each line in the .txt file should contain a bounding box in this format\+: 
\begin{DoxyCode}{0}
\DoxyCodeLine{0\ x\_center\ y\_center\ width\ height}

\end{DoxyCode}


For images without the object\+: the .txt file will be empty (zero length).

You can check training progress using {\ttfamily Tensorboard} by passing it the log directory\+:


\begin{DoxyCode}{0}
\DoxyCodeLine{tensorboard\ -\/-\/logdir=logs}

\end{DoxyCode}


This allows you to monitor accuracy values throughout training, so you can see how its going and when you might want to stop model training.\hypertarget{md_guides_2usage_autotoc_md16}{}\doxysection{\texorpdfstring{\href{../model_evaluator.py}{\texttt{ model\+\_\+evaluator.\+py}}}{\href{../model_evaluator.py}{\texttt{ model\+\_\+evaluator.\+py}}}}\label{md_guides_2usage_autotoc_md16}
This file contains a class, {\ttfamily Model\+Evaluator}, which can be instantiated in Python as shown to load the weights for model 8\+: 
\begin{DoxyCode}{0}
\DoxyCodeLine{\textcolor{keyword}{from}\ model\_evaluator\ \textcolor{keyword}{import}\ ModelEvaluator}
\DoxyCodeLine{me\ =\ ModelEvaluator(16,\ (120,\ 160,\ 3),\ \textcolor{stringliteral}{"{}model\_weights/8/checkpoints/weights.10.hdf5"{}},\ \textcolor{stringliteral}{"{}/path/to/validation/data"{}})\ }
\DoxyCodeLine{me.evaluate()}

\end{DoxyCode}
 You can also call {\ttfamily model\+\_\+evaluator.\+py} from the command line\+: 
\begin{DoxyCode}{0}
\DoxyCodeLine{python\ model\_evaluator.py\ \(\backslash\)}
\DoxyCodeLine{\ \ \ \ -\/-\/batch\_size\ 16\ \(\backslash\)}
\DoxyCodeLine{\ \ \ \ -\/-\/weights\_path\ "{}model\_weights/8/checkpoints/weights.10.hdf5"{}\ \(\backslash\)}
\DoxyCodeLine{\ \ \ \ -\/-\/test\_data\_dir\ "{}/path/to/validation/data"{}}

\end{DoxyCode}



\begin{DoxyCode}{0}
\DoxyCodeLine{>\ Input:\ Trained\ \`{}.hdf5`\ model,\ test\ image\ folder\ }
\DoxyCodeLine{>\ Output:\ Accuracy\ score,\ loss\ printed\ to\ terminal\ window}

\end{DoxyCode}
\hypertarget{md_guides_2usage_autotoc_md17}{}\doxysection{\texorpdfstring{\href{../model_quantiser.py}{\texttt{ model\+\_\+quantiser.\+py}}}{\href{../model_quantiser.py}{\texttt{ model\+\_\+quantiser.\+py}}}}\label{md_guides_2usage_autotoc_md17}
This file contains a class, {\ttfamily Model\+Quantiser} which can be instantiated in Python as shown to quantise a given model in keras {\ttfamily .hdf5} format and save it as a {\ttfamily .tflite} file. 
\begin{DoxyCode}{0}
\DoxyCodeLine{\textcolor{keyword}{from}\ model\_quantiser\ \textcolor{keyword}{import}\ ModelQuantiser}
\DoxyCodeLine{mq\ =\ ModelQuantiser(}
\DoxyCodeLine{\ \ \ \ \ \ \ \ weights\_file=\textcolor{stringliteral}{"{}/path/to/weights.hdf5"{}},}
\DoxyCodeLine{\ \ \ \ \ \ \ \ representative\_dataset=\textcolor{stringliteral}{"{}/path/to/representative\_dataset,}}
\DoxyCodeLine{\textcolor{stringliteral}{\ \ \ \ \ \ \ \ representative\_example\_nr=100}}
\DoxyCodeLine{\textcolor{stringliteral}{\ \ \ \ )}}
\DoxyCodeLine{\textcolor{stringliteral}{\ \ \ \ }\textcolor{comment}{\#\ Quantise\ the\ model}}
\DoxyCodeLine{\ \ \ \ quantiser.quantise\_model(output\_path=\textcolor{stringliteral}{"{}/path/to/weights.tflite"{}})}

\end{DoxyCode}
 You can also call {\ttfamily model\+\_\+quantiser.\+py} from the command line\+: 
\begin{DoxyCode}{0}
\DoxyCodeLine{python\ model\_quantiser.py\ \(\backslash\)}
\DoxyCodeLine{\ \ -\/-\/weights\_file\ /path/to/weights.hdf5\ \(\backslash\)}
\DoxyCodeLine{\ \ -\/-\/representative\_dataset\ /path/to/representative\_dataset\ \(\backslash\)}
\DoxyCodeLine{\ \ -\/-\/representative\_example\_nr\ 100\ \(\backslash\)}
\DoxyCodeLine{\ \ -\/-\/output\ /path/to/weights.tflite}

\end{DoxyCode}



\begin{DoxyCode}{0}
\DoxyCodeLine{>\ Input:\ Trained\ \`{}.hdf5`\ model,\ image\ folder\ for\ representative\ dataset}
\DoxyCodeLine{>\ Output:\ \`{}.tflite`\ model\ file\ (optimised\ using\ quantisation)}

\end{DoxyCode}
 \hypertarget{md_guides_2usage_autotoc_md18}{}\doxysection{\texorpdfstring{\href{../saliency_map_evaluator.py}{\texttt{ saliency\+\_\+map\+\_\+evaluator.\+py}}}{\href{../saliency_map_evaluator.py}{\texttt{ saliency\+\_\+map\+\_\+evaluator.\+py}}}}\label{md_guides_2usage_autotoc_md18}
This file contains a class {\ttfamily Saliency\+Map\+Generator}, which can plot saliency maps alongside output confidence and the input image. It can be accessed in python as follows\+: 
\begin{DoxyCode}{0}
\DoxyCodeLine{\textcolor{keyword}{from}\ saliency\_map\_evaluator\ \textcolor{keyword}{import}\ SaliencyMapGenerator}
\DoxyCodeLine{smg\ =\ SaliencyMapGenerator(weights\_file=\textcolor{stringliteral}{"{}model\_weights/8/checkpoints/weights.10.hdf5"{}})}
\DoxyCodeLine{smg.generate\_saliency\_map(input\_image\_path=\textcolor{stringliteral}{"{}input.png"{}},\ output\_path=\textcolor{stringliteral}{"{}saliency\_plot.png"{}})}

\end{DoxyCode}
 You can also call {\ttfamily saliency\+\_\+map\+\_\+evaluator.\+py} from the command line\+: 
\begin{DoxyCode}{0}
\DoxyCodeLine{python\ saliency\_map\_evaluator.py\ \(\backslash\)}
\DoxyCodeLine{\ \ -\/-\/weights\_file\ model\_weights/8/checkpoints/weights.10.hdf5\ \(\backslash\)}
\DoxyCodeLine{\ \ -\/-\/input\_image\ input.png\ \(\backslash\)}
\DoxyCodeLine{\ \ -\/-\/output\ saliency\_plot.png}

\end{DoxyCode}
 
\begin{DoxyCode}{0}
\DoxyCodeLine{>\ Input:\ A\ trained\ model\ and\ input\ image}
\DoxyCodeLine{>\ Output:\ An\ image\ showing\ the\ rescaled\ input,\ saliency\ map\ and\ an\ overlay\ with\ prediction\ confidence}

\end{DoxyCode}
\hypertarget{md_guides_2usage_autotoc_md19}{}\doxysection{\texorpdfstring{\href{../generator.py}{\texttt{ generator.\+py}}}{\href{../generator.py}{\texttt{ generator.\+py}}}}\label{md_guides_2usage_autotoc_md19}
This file contains a class {\ttfamily Custom\+Data\+Generator}, which provides an iterable generator for Keras models, handling the preprocessing, augmentation, and batching of data for YOLO-\/format object detection annotations to binary classification ones.

You can use {\ttfamily Custom\+Data\+Generator} in Python as follows\+: 
\begin{DoxyCode}{0}
\DoxyCodeLine{\textcolor{keyword}{from}\ generator\ \textcolor{keyword}{import}\ CustomDataGenerator}
\DoxyCodeLine{data\_gen\ =\ CustomDataGenerator(}
\DoxyCodeLine{\ \ \ \ data\_directory=\textcolor{stringliteral}{"{}/path/to/dataset"{}},}
\DoxyCodeLine{\ \ \ \ batch\_size=16,}
\DoxyCodeLine{\ \ \ \ input\_shape=(224,\ 224,\ 3),}
\DoxyCodeLine{\ \ \ \ stop\_training\_flag=\{\textcolor{stringliteral}{"{}stop"{}}:\ \textcolor{keyword}{False}\},}
\DoxyCodeLine{\ \ \ \ shuffle=\textcolor{keyword}{True}}
\DoxyCodeLine{)}
\DoxyCodeLine{X,\ y\ =\ data\_gen[0]}

\end{DoxyCode}



\begin{DoxyCode}{0}
\DoxyCodeLine{>\ Input:\ Folder\ of\ images}
\DoxyCodeLine{>\ Output:\ Numpy\ arrays\ of\ image\ batches}

\end{DoxyCode}
 