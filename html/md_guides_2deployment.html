<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.13.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Ecto-Trigger: Deployment</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Ecto-Trigger<span id="projectnumber">&#160;0.1</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.13.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('md_guides_2deployment.html',''); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Deployment</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md4"></a></p>
<p>Here you will find information on how to deploy models you have trained using Ecto-Trigger.</p>
<details  open="true">
<summary >
Raspberry Pi</summary>
<p></p>
<p>To execute the models on Raspberry Pi systems, you can choose to use the Tensorflow or TFLite runtime (reccomended). To use the TFLite runtime, check out the guidance <a href="https://ai.google.dev/edge/litert/microcontrollers/python">here</a>. Basic steps:</p>
<p>(On RPi) </p><div class="fragment"><div class="line">python3 -m pip install tflite-runtime</div>
</div><!-- fragment --><p>Using Python </p><div class="fragment"><div class="line">from PIL import Image</div>
<div class="line">import tflite_runtime.interpreter as tflite</div>
<div class="line"> </div>
<div class="line">def load_model_and_predict(image_path, model_path):</div>
<div class="line">    interpreter = tf.lite.Interpreter(model_path=model_path)</div>
<div class="line">    interpreter.allocate_tensors()</div>
<div class="line"> </div>
<div class="line">    input_details = interpreter.get_input_details()</div>
<div class="line">    output_details = interpreter.get_output_details()</div>
<div class="line"> </div>
<div class="line">    height = input_details[0][&#39;shape&#39;][1]</div>
<div class="line">    width = input_details[0][&#39;shape&#39;][2]</div>
<div class="line">    img = Image.open(image_path).resize((width, height))</div>
<div class="line"> </div>
<div class="line">    input_data = np.expand_dims(img, axis=0)</div>
<div class="line">    if input_details[0][&#39;dtype&#39;] == np.float32:</div>
<div class="line">        input_data = (np.float32(input_data) - 127.5) / 127.5</div>
<div class="line"> </div>
<div class="line">    interpreter.set_tensor(input_details[0][&#39;index&#39;], input_data)</div>
<div class="line">    interpreter.invoke()</div>
<div class="line"> </div>
<div class="line">    output_data = interpreter.get_tensor(output_details[0][&#39;index&#39;])</div>
<div class="line">    prediction = np.squeeze(output_data)</div>
<div class="line">    print(1 if prediction &gt; 0.5 else 0)</div>
</div><!-- fragment --><p></p>
</details>
<details  open="true">
<summary >
ESP32-S3</summary>
<p>World!</p>
<p>So far, we have found success deploying Ecto-Trigger to ESP32-S3 devices using the <a href="https://github.com/espressif/esp-nn">ESP-NN library</a> to accelerate inference time for TFLite models. We hope to provide a library for this in the future. For now, here are basic steps we took to enable this.</p>
<p></p>
</details>
<h2><a class="anchor" id="autotoc_md5"></a>
Development Environment</h2>
<p>First you must set up a development environment which allows you to compile and run code for Espressive devices. Follow the <a href="https://docs.espressif.com/projects/esp-idf/en/stable/esp32s3/get-started/index.html">guidance from Espressive</a> to get the esp idf. Details are given below for Ubuntu users:</p>
<p>Dependencies:</p>
<div class="fragment"><div class="line">sudo apt-get install git wget flex bison gperf python3 python3-pip python3-venv cmake ninja-build ccache libffi-dev libssl-dev dfu-util libusb-1.0-0</div>
</div><!-- fragment --><p> Download idf </p><div class="fragment"><div class="line">mkdir -p ~/esp</div>
<div class="line">cd ~/esp</div>
<div class="line">git clone -b v5.4 --recursive https://github.com/espressif/esp-idf.git</div>
</div><!-- fragment --><p> Install idf </p><div class="fragment"><div class="line">cd ~/esp/esp-idf</div>
<div class="line">./install.sh esp32s3</div>
</div><!-- fragment --> <h2><a class="anchor" id="autotoc_md6"></a>
Using the idf</h2>
<p>First, set environment variabes: </p><div class="fragment"><div class="line">. $HOME/esp/esp-idf/export.sh</div>
</div><!-- fragment --><p> This ensures the <code>IDF_PATH</code> environment variable is set, allowing you to use <code>idf.py</code>. You must do this each time you open a new shell.</p>
<h2><a class="anchor" id="autotoc_md7"></a>
Person detection</h2>
<p>Espressive already provide an example which runs a person detection neural network in thier code, we can modify this to run our own models.</p>
<p>Get the example code: </p><div class="fragment"><div class="line">cd ~/esp</div>
<div class="line">cp -r $IDF_PATH/examples/get-started/person_detection .</div>
</div><!-- fragment --><p>Configure the project: </p><div class="fragment"><div class="line">cd ~/esp/hello_world</div>
<div class="line">idf.py set-target esp32s3</div>
<div class="line">idf.py menuconfig</div>
</div><!-- fragment --><p> A menu will now appear, allowing you to control the configuration of the ESP32-S3. It is important to enable PSRAM here as the Ecto-Trigger models are larger than can be allocated in the standard amount of SRAM on ESP32-S3. In the future, it would be interesting to reduce model sizes such that this isn't required. To enable the PSRAM, follow instructions <a href="https://docs.espressif.com/projects/esp-idf/en/release-v4.4/esp32s3/api-guides/flash_psram_config.html">here</a>: "Enable the CONFIG_ESP32S3_SPIRAM_SUPPORT under Component config / ESP32-S3-Specific menu.".</p>
<p>Next, give the project a build and flash it to the plugged in board to ensure there are no issues: </p><div class="fragment"><div class="line">idf.py build</div>
<div class="line">idf.py flash</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md8"></a>
Modification</h2>
<p>All being well, we can modify the <code>person_detection</code> code for use with Ecto-Trigger models. First, parse the quantised <code>.tflite</code> models into C data arrays. </p><div class="fragment"><div class="line">xxd -i /path/to/model.tflite &gt; model.cc</div>
</div><!-- fragment --><p> Make a C header file for this.</p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.13.2 </li>
  </ul>
</div>
</body>
</html>
